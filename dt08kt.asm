
MSS EQU 21H
M01 EQU 22H
M02 EQU 23H
M03 EQU 24H
M04 EQU 25H
M05 EQU 26H
M06 EQU 27H


TEMP DATA 20H

DIV1 BIT TEMP.0
DIV2 BIT TEMP.1

;~~~~~~~~BEGIN~~~~~~~~
ORG		0000H
JMP		BEGIN
ORG		0001BH
JMP OUT_LINE


BEGIN:
SETB TEMP.0
SETB TEMP.1
MOV MSS,#0
MOV M01,#0
MOV M02,#0
MOV M03,#0
MOV M04,#0
MOV M05,#0
MOV M06,#0
MOV P0,#0
MOV P1,#0
MOV P2,#0
MOV P3,#0

MOV IE,#88H				;CHO PHEP NGAT DO BO DINH THOI 1
MOV TMOD,#10H			; TIMER 1 CHE DO 16BIT
SETB TF1
SETB TR1



MAIN:
	CALL CHOP_CH_RUOU
	CALL SANG_DON
	CALL CHOP_CH_RUOU
	CALL CHOP_RUOU
	CALL CHOP_PHAP
	CALL CHOP_CH_RUOU
	CLR TR1
	MOV P3,#255
	MOV R3,#10
LN1:
	CALL PWM_ALL
	DJNZ R3,LN1
	SETB TR1
	CALL CHOP_CHOP
	CALL CHOP_CHOP
	
	CALL SANG_DAN
	CALL DELAY500MS
	CALL TAT_DAN
 	CALL CHOP_XEN_KE_RP
 	
	CLR TR1
	MOV P3,#255
	MOV R3,#30
LN2:
	CALL PWM_XEN_KE2
	DJNZ R3,LN2
	SETB TR1
	CALL CHOP_RUOU
	CALL SANG_RUOU
	CALL CHOP_PHAP
	CALL SANG_PHAP
	CALL CHOP_CH_RUOU
	CLR TR1
	MOV P3,#255
	MOV R3,#30
LN3:
	CALL PWM_XEN_KE1
	DJNZ R3,LN3
	SETB TR1
	CALL CHOP_XEN_KE_RP
	CALL SANG_ALL
	CALL DELAY500MS
	CALL TAT_DAN
	CALL SANG_DAN
	CALL DELAY250MS
JMP MAIN

PWM_ALL:
		MOV R4,#100
W1:
		CALL SANG_ALL
		CALL DELAY1X
		CALL TAT_ALL
		CALL DELAY_1X
		DJNZ R4,W1
		MOV R4,#100
W2:
		
		CALL DELAY2X
		CALL TAT_ALL
		CALL DELAY_2X
		DJNZ R4,W2
		
		
		MOV R4,#100
W3:
		CALL SANG_ALL
		CALL DELAY3X
		CALL TAT_ALL
		CALL DELAY_3X
		DJNZ R4,W3
		
		MOV R4,#100
W4:
		CALL SANG_ALL
		CALL DELAY4X
		CALL TAT_ALL
		CALL DELAY_4X
		DJNZ R4,W4
		
		
		MOV R4,#100
W5:
		CALL SANG_ALL
		CALL DELAY5X
		CALL TAT_ALL
		CALL DELAY_5X
		DJNZ R4,W5
		
		MOV R4,#100
W6:
		CALL TAT_ALL
		CALL DELAY1X
		CALL SANG_ALL
		CALL DELAY_1X
		DJNZ R4,W6
		MOV R4,#100
W7:
		CALL TAT_ALL
		CALL DELAY2X
		CALL SANG_ALL
		CALL DELAY_2X
		DJNZ R4,W7
		
		
		MOV R4,#100
W8:
		CALL TAT_ALL
		CALL DELAY3X
		CALL SANG_ALL
		CALL DELAY_3X
		DJNZ R4,W8
		
		MOV R4,#100
W9:
		CALL TAT_ALL
		CALL DELAY4X
		CALL SANG_ALL
		CALL DELAY_4X
		DJNZ R4,W9
		
		
		MOV R4,#100
W10:
		CALL TAT_ALL
		CALL DELAY5X
		CALL SANG_ALL
		CALL DELAY_5X
		DJNZ R4,W10
		RET
	
PWM_XEN_KE1:
		
		MOV R4,#100
Y1:
		CALL S_RUOU_PHAP
		MOV P3,#0
		CALL DELAY1X
		CALL T_RUOU_PHAP
		MOV P3,#255
	
		CALL DELAY_1X
		DJNZ R4,Y1
		MOV R4,#100
Y2:
		
		CALL S_RUOU_PHAP
		MOV P3,#0
		CALL DELAY2X
		CALL T_RUOU_PHAP
		MOV P3,#255
		CALL DELAY_2X
		DJNZ R4,Y2
		
		
		MOV R4,#100
Y3:
		CALL S_RUOU_PHAP
		MOV P3,#0
		CALL DELAY3X
		CALL T_RUOU_PHAP
		MOV P3,#255
		CALL DELAY_3X
		DJNZ R4,Y3
		
		MOV R4,#100
Y4:
		CALL S_RUOU_PHAP
		MOV P3,#0
		CALL DELAY4X
		CALL T_RUOU_PHAP
		MOV P3,#255
		CALL DELAY_4X
		DJNZ R4,Y4
		
		
		MOV R4,#100
Y5:
		CALL S_RUOU_PHAP
		MOV P3,#0
		CALL DELAY5X
		CALL T_RUOU_PHAP
		MOV P3,#255
		CALL DELAY_5X
		DJNZ R4,Y5
		
		
		
		
		
		MOV R4,#100
Y6:
		CALL T_RUOU_PHAP
		MOV P3,#255
		CALL DELAY1X
		CALL S_RUOU_PHAP
		MOV P3,#0
		CALL DELAY_1X
		DJNZ R4,Y6
		MOV R4,#100
Y7:
		CALL T_RUOU_PHAP
		MOV P3,#255
		CALL DELAY2X
		CALL S_RUOU_PHAP
		MOV P3,#0
		CALL DELAY_2X
		DJNZ R4,Y7
		
		
		MOV R4,#100
Y8:
		CALL T_RUOU_PHAP
		MOV P3,#255
		CALL DELAY3X
		CALL S_RUOU_PHAP
		MOV P3,#0
		CALL DELAY_3X
		DJNZ R4,Y8
		
		MOV R4,#100
Y9:
		CALL T_RUOU_PHAP
		MOV P3,#255
		CALL DELAY4X
		CALL S_RUOU_PHAP
		MOV P3,#0
		CALL DELAY_4X
		DJNZ R4,Y9
		
		
		MOV R4,#100
Y10:
		CALL T_RUOU_PHAP
		MOV P3,#255
		CALL DELAY5X
		CALL S_RUOU_PHAP
		MOV P3,#0
		CALL DELAY_5X
		DJNZ R4,Y10
		RET


PWM_XEN_KE2:
		
		MOV R4,#100
K1:
		CALL XEN_KE_PR
		
		MOV P3,#00110011B
		CALL DELAY1X
		CALL XEN_KE_RP
		MOV P3,#11001100B
		CALL DELAY_1X
		DJNZ R4,K1
		MOV R4,#100
K2:
		
		CALL XEN_KE_PR
		MOV P3,#00110011B
		CALL DELAY2X
		CALL XEN_KE_RP
		MOV P3,#11001100B
		CALL DELAY_2X
		DJNZ R4,K2
		
		
		MOV R4,#100
K3:
		CALL XEN_KE_PR
		MOV P3,#00110011B
		CALL DELAY3X
		CALL XEN_KE_RP
		MOV P3,#11001100B
		CALL DELAY_3X
		DJNZ R4,K3
		
		MOV R4,#100
K4:
		CALL XEN_KE_PR
		MOV P3,#00110011B
		CALL DELAY4X
		CALL XEN_KE_RP
		MOV P3,#11001100B
		CALL DELAY_4X
		DJNZ R4,K4
		
		
		MOV R4,#100
K5:
		CALL XEN_KE_PR
		MOV P3,#00110011B
		CALL DELAY5X
		CALL XEN_KE_RP
		MOV P3,#11001100B
		CALL DELAY_5X
		DJNZ R4,K5
		
		
		
		
		
		MOV R4,#100
K6:
		CALL XEN_KE_RP
		MOV P3,#11001100B
		CALL DELAY1X
		CALL XEN_KE_PR
		MOV P3,#00110011B
		CALL DELAY_1X
		DJNZ R4,K6
		MOV R4,#100
K7:
		CALL XEN_KE_RP
		MOV P3,#11001100B
		CALL DELAY2X
		CALL XEN_KE_PR
		MOV P3,#00110011B
		CALL DELAY_2X
		DJNZ R4,K7
		
		
		MOV R4,#100
K8:
		CALL XEN_KE_RP
		MOV P3,#11001100B
		CALL DELAY3X
		CALL XEN_KE_PR
		MOV P3,#00110011B
		CALL DELAY_3X
		DJNZ R4,K8
		
		MOV R4,#100
K9:
		CALL XEN_KE_RP
		MOV P3,#11001100B
		CALL DELAY4X
		CALL XEN_KE_PR
		MOV P3,#00110011B
		CALL DELAY_4X
		DJNZ R4,K9
		
		
		MOV R4,#100
K10:
		CALL XEN_KE_RP
		MOV P3,#11001100B
		CALL DELAY5X
		CALL XEN_KE_PR
		MOV P3,#00110011B
		CALL DELAY_5X
		DJNZ R4,K10
		RET

	

CHOP_CH_RUOU:
		
		MOV R4,#10
LOOP_CHOPXX:
		CALL SANG_CH_RUOU
		CALL DELAY25MS
		CALL TAT_CH_RUOU
		CALL DELAY25MS
		DJNZ R4,LOOP_CHOPXX
		CALL SANG_CH_RUOU
		
		RET








	

	



SANG_DON:
	MOV 40H,#8
	MOV R5,#0FFH
LAP2:
	MOV A,#0FEH
	MOV R6,40H
LAP:
	PUSH ACC
	ANL A,R5
	CPL A
	MOV P0,A
	MOV P1,A
	MOV P2,A
	POP ACC
	RL A
	CALL DELAY50MS
	DJNZ R6,LAP
	DEC 40H
	MOV A,R5
	CLR C
	RRC A
	MOV R5,A
	CJNE A,#0,LAP2
	CALL CHOP_CHOP
	MOV 40H,#8
	MOV R5,#0FFH
LAP3:
	MOV A,#0FEH
	MOV R6,40H
LAP4:
	PUSH ACC
	ANL A,R5
	CPL A
	MOV P0,A
	MOV P1,A
	MOV P2,A
	POP ACC
	RR A
	CALL DELAY50MS
	DJNZ R6,LAP4
	DEC 40H
	MOV A,R5
	CLR c
	RLC A
	MOV R5,A
	CJNE A,#0,LAP3
	CALL CHOP_CHOP
	RET


CHOP_CHOP:
		MOV R4,#10
LOOP_CHOP:
		CALL S_RUOU_PHAP
		CALL DELAY25MS
		CALL T_RUOU_PHAP
		CALL DELAY25MS
		DJNZ R4,LOOP_CHOP
		RET
		
		

		
CHOP_RUOU:
		MOV R4,#10
LOOP_CHOP_RUOU:
		CALL SANG_RUOU
		CALL DELAY25MS
		CALL TAT_RUOU
		CALL DELAY25MS
		DJNZ R4,LOOP_CHOP_RUOU
		RET
		
CHOP_PHAP:
		MOV R4,#10
LOOP_CHOP_PHAP:
		CALL SANG_PHAP
		CALL DELAY25MS
		CALL TAT_PHAP
		CALL DELAY25MS
		DJNZ R4,LOOP_CHOP_PHAP
		RET

SANG_DAN:
		MOV A,#0
		MOV R4,#9
LOOP_S_DAN:		
		MOV P0,A
		MOV P1,A
		MOV P2,A
		CALL DELAY50MS
		SETB C
		RLC A
		DJNZ R4,LOOP_S_DAN
		RET
TAT_DAN:
		MOV A,#255
		MOV R4,#9
LOOP_T_DAN:		
		MOV P0,A
		MOV P1,A
		MOV P2,A
		CALL DELAY50MS
		CLR C
		RRC A
		DJNZ R4,LOOP_T_DAN
		RET
		
		
		
CHOP_XEN_KE_RP:
		MOV R4,#10
LOOP_XEN_KE_RP:
		CALL XEN_KE_RP
		CALL DELAY25MS
		CALL XEN_KE_PR
		CALL DELAY25MS
		DJNZ R4,LOOP_XEN_KE_RP
		RET
;----------------------------------------------

SANG_RUOU:
		SETB P0.0
		SETB P0.1
		SETB P0.2
		SETB P0.3
		SETB P1.0
		SETB P1.1
		SETB P1.2
		SETB P1.3
		SETB P2.0
		SETB P2.1
		SETB P2.2
		SETB P2.3
		RET
		
		
TAT_RUOU:
		CLR P0.0
		CLR P0.1
		CLR P0.2
		CLR P0.3
		CLR P1.0
		CLR P1.1
		CLR P1.2
		CLR P1.3
		CLR P2.0
		CLR P2.1
		CLR P2.2
		CLR P2.3
		RET
		
		
SANG_PHAP:
		SETB P0.4
		SETB P0.5
		SETB P0.6
		SETB P0.7
		
		SETB P1.4
		SETB P1.5
		SETB P1.6
		SETB P1.7
		
		SETB P2.4
		SETB P2.5
		SETB P2.6
		SETB P2.7
		RET		
		
TAT_PHAP:
		CLR P0.4
		CLR P0.5
		CLR P0.6
		CLR P0.7
		
		CLR P1.4
		CLR P1.5
		CLR P1.6
		CLR P1.7
		
		CLR P2.4
		CLR P2.5
		CLR P2.6
		CLR P2.7
		RET

S_RUOU_PHAP:
		MOV P0,#255
		MOV P1,#255
		MOV P2,#255
		RET
T_RUOU_PHAP:
		MOV P0,#0
		MOV P1,#0
		MOV P2,#0
		RET
			
XEN_KE_RP:
		MOV P0,#10101010B
		MOV P1,#10101010B
		MOV P2,#10101010B
		RET
XEN_KE_PR:
		MOV P0,#01010101B
		MOV P1,#01010101B
		MOV P2,#01010101B
		RET
SANG_ALL:
		MOV P0,#255
		MOV P1,#255
		MOV P2,#255
		MOV P3,#255
		RET
TAT_ALL:
		MOV P0,#0
		MOV P1,#0
		MOV P2,#0
		MOV P3,#0
		RET
SANG_CH_RUOU:
		SETB P3.7
		SETB P3.6
		RET
TAT_CH_RUOU:
		CLR P3.7
		CLR P3.6
		RET					
			
;-------------------------

DELAY500MS:
		CALL DELAY250MS
		CALL DELAY250MS
		RET
DELAY250MS:
		CALL DELAY50MS
		CALL DELAY200MS
		RET
DELAY200MS:
		CALL DELAY100MS
		CALL DELAY100MS
		RET
DELAY150MS:
		CALL DELAY50MS
		CALL DELAY100MS
		RET		
DELAY100MS:
		CALL DELAY50MS
		CALL DELAY50MS
		RET
DELAY50MS:
		CALL DELAY25MS
		CALL DELAY25MS
		RET
DELAY25MS:
	MOV 30H,#200
L_DELAY25MS:
	MOV 31H,#249
	DJNZ 31H,$
	DJNZ 30H,L_DELAY25MS
	RET



DELAY1X:
		NOP
		RET
DELAY2X:
		MOV R0,#50
		DJNZ R0,$
		RET
DELAY3X:
		MOV R0,#100
		DJNZ R0,$
		RET
DELAY4X:
		MOV R0,#200
		DJNZ R0,$
		RET
DELAY5X:
		CALL DELAY4X
		CALL DELAY4X
		RET
		
DELAY_1X:
		CALL DELAY5X
		RET
DELAY_2X:
		CALL DELAY2X
		CALL DELAY3X
		CALL DELAY4X
		RET
DELAY_3X:
		CALL DELAY3X
		CALL DELAY4X
		RET
DELAY_4X:
		CALL DELAY4X
		RET
DELAY_5X:
		CALL DELAY1X
		RET




OUT_LINE:
MOV TH1,#HIGH(-50000)
MOV TL1,#LOW (-50000)
CPL DIV1
JNB DIV1,EX_OUT_LINE

CPL DIV2
JNB DIV2,EX_OUT_LINE




CALL SELECT

EX_OUT_LINE:
RETI

SELECT:
		MOV R7,MSS
		CJNE R7,#0,CONT1_SELECT
		CALL RIGHT
		JMP EX_SELECT
CONT1_SELECT:
		MOV R7,MSS			
		CJNE R7,#1,CONT2_SELECT
		CALL LEFT
		JMP EX_SELECT
CONT2_SELECT:
		MOV R7,MSS
		CJNE R7,#2,EX_SELECT
		CALL FLASH
EX_SELECT:
		RET



RIGHT:
		MOV R7,M02
		CJNE R7,#100,LOOP_RIGHT
		MOV M02,#0
		MOV MSS,#2
		JMP EX_RIGHT
LOOP_RIGHT:		
		INC M02
		MOV R7,M01
		CJNE R7,#0,CONT1_RIGHT
		SETB P3.0
		SETB P3.1
		CLR P3.2
		CLR P3.3
		CLR P3.4
		CLR P3.5
		INC M01
		JMP EX_RIGHT
CONT1_RIGHT:
		CJNE R7,#1,CONT2_RIGHT
		CLR P3.0
		CLR P3.1
		SETB P3.2
		SETB P3.3
		CLR P3.4
		CLR P3.5
		INC M01
		JMP EX_RIGHT
CONT2_RIGHT:
		CJNE R7,#2,EX_RIGHT
		CLR P3.0
		CLR P3.1
		CLR P3.2
		CLR P3.3
		SETB P3.4
		SETB P3.5
		MOV M01,#0		
EX_RIGHT:
		RET
		
		
LEFT:
		MOV R7,M03
		CJNE R7,#100,LOOP_LEFT
		MOV M03,#0
		MOV MSS,#0
		JMP EX_LEFT
LOOP_LEFT:		
		INC M03
		MOV R7,M04
		CJNE R7,#0,CONT1_LEFT
		CLR P3.0
		CLR P3.1
		CLR P3.2
		CLR P3.3
		SETB P3.4
		SETB P3.5
		INC M04
		JMP EX_LEFT
CONT1_LEFT:
		CJNE R7,#1,CONT2_LEFT
		CLR P3.0
		CLR P3.1
		SETB P3.2
		SETB P3.3
		CLR P3.4
		CLR P3.5
		INC M04
		JMP EX_LEFT
CONT2_LEFT:
		CJNE R7,#2,EX_LEFT
		SETB P3.0
		SETB P3.1
		CLR P3.2
		CLR P3.3
		CLR P3.4
		CLR P3.5
		MOV M04,#0		
EX_LEFT:
		RET		


FLASH:
		MOV R7,M05
		CJNE R7,#50,LOOP_FLASH
		MOV M05,#0
		MOV MSS,#1
		JMP FLASH
LOOP_FLASH:		
		INC M05
		MOV R7,M06
		CJNE R7,#0,CONT2_FLASH
		SETB P3.0
		SETB P3.1
		SETB P3.2
		SETB P3.3
		SETB P3.4
		SETB P3.5
		INC M06
		JMP EX_FLASH
CONT2_FLASH:
		CJNE R7,#1,EX_FLASH
		CLR P3.0
		CLR P3.1
		CLR P3.2
		CLR P3.3
		CLR P3.4
		CLR P3.5
		MOV M06,#0		
EX_FLASH:
		RET		






		

END



















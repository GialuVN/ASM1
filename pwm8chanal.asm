;DINH NGHIA
CH1 BIT P1.0
CH2 BIT P1.1
CH3 BIT P1.2
CH4 BIT P1.3
CH5 BIT P1.4
CH6 BIT P1.5
CH7 BIT P1.6
CH8 BIT P1.7
;KHAI  BAO BIEN
V_CH1	DATA 30H
V_CH2	DATA 31H
V_CH3	DATA 32H
V_CH4	DATA 33H
V_CH5	DATA 34H
V_CH6	DATA 35H
V_CH7	DATA 36H
V_CH8	DATA 37H

T_CH1	DATA 40H
T_CH2	DATA 41H
T_CH3	DATA 42H
T_CH4	DATA 43H
T_CH5	DATA 44H
T_CH6	DATA 45H
T_CH7	DATA 46H
T_CH8	DATA 47H

L_CH1	DATA 50H
L_CH2	DATA 51H
L_CH3	DATA 52H
L_CH4	DATA 53H
L_CH5	DATA 54H
L_CH6	DATA 55H
L_CH7	DATA 56H
L_CH8	DATA 57H

H_CH1	DATA 60H
H_CH2	DATA 61H
H_CH3	DATA 62H
H_CH4	DATA 63H
H_CH5	DATA 64H
H_CH6	DATA 65H
H_CH7	DATA 66H
H_CH8	DATA 67H


C50MS	DATA 50H
C100MS	DATA 51H
C500MS	DATA 52H

TEMP	DATA 20H
T10MS	BIT TEMP.0
T50MS	BIT TEMP.1
T100MS  BIT TEMP.2
T500MS	BIT TEMP.3
T10MS_ 	BIT TEMP.4


	ORG 0
	JMP BEGIN
;	ORG 0003H
;	JMP INT_EX0		;NGAT NGOAI 0
	ORG 001BH
	MOV TH1,#HIGH(-10000)
	MOV TL1,#LOW(-10000)
	SETB T10MS_
	SETB T10MS
	CALL TIMING
	RETI
BEGIN:
;KHOI TAO

	MOV TMOD,#10H	;TIMER1,CHE DO 16 BIT
	MOV IE,#88H		;CHO PHEP NGAT DO TIMER 1
	SETB TR1
	SETB TF1
	
	
	MOV C50MS,#5
	MOV C100MS,#10
	MOV C500MS,#50
	
	
	
	MOV T_CH1,#0
	MOV T_CH2,#36
	MOV T_CH3,#73
	MOV T_CH4,#109
	MOV T_CH5,#145
	MOV T_CH6,#181
	MOV T_CH7,#217
	MOV T_CH8,#255
	CALL MAKE
	CALL PWM_8X
MAIN:
	
	
	MOV R0,#3FH
	MOV R1,#40H
LOOP_R:	
	MOV A,@R1
	MOV @R0,A
	INC R1
	INC R0
	CJNE R1,#48H,LOOP_R
	MOV 47H,3FH
	CALL MAKE
	CALL PWM_8X
	





	JMP MAIN


PWM_8X:
		CALL PWM_8C
		JNB T50MS,PWM_8X
		CLR T50MS
		RET
		


;PHAT XUNG PWM 8 KENH
PWM_8C:
		DJNZ V_CH1,TO_CH1
		CPL CH1
		JB CH1,TO_LCH1
		MOV V_CH1,H_CH1
		JMP TO_CH1
TO_LCH1:
		MOV V_CH1,L_CH1
TO_CH1:
	
		DJNZ V_CH2,TO_CH2
		CPL CH2
		JB CH2,TO_LCH2
		MOV V_CH2,H_CH2
		JMP TO_CH2
TO_LCH2:
		MOV V_CH2,L_CH2
TO_CH2:
	
		DJNZ V_CH3,TO_CH3
		CPL CH3
		JB CH3,TO_LCH3
		MOV V_CH3,H_CH3
		JMP TO_CH3
TO_LCH3:
		MOV V_CH3,L_CH3
TO_CH3:
	
		DJNZ V_CH4,TO_CH4
		CPL CH4
		JB CH4,TO_LCH4
		MOV V_CH4,H_CH4
		JMP TO_CH4
TO_LCH4:
		MOV V_CH4,L_CH4
TO_CH4:
	
		DJNZ V_CH5,TO_CH5
		CPL CH5
		JB CH5,TO_LCH5
		MOV V_CH5,H_CH5
		JMP TO_CH5
TO_LCH5:
		MOV V_CH5,L_CH5
TO_CH5:
	
		DJNZ V_CH6,TO_CH6
		CPL CH6
		JB CH6,TO_LCH6
		MOV V_CH6,H_CH6
		JMP TO_CH6
TO_LCH6:
		MOV V_CH6,L_CH6
TO_CH6:
	
		DJNZ V_CH7,TO_CH7
		CPL CH7
		JB CH7,TO_LCH7
		MOV V_CH7,H_CH7
		JMP TO_CH7
TO_LCH7:
		MOV V_CH7,L_CH7
TO_CH7:

		DJNZ V_CH8,TO_CH8
		CPL CH8
		JB CH8,TO_LCH8
		MOV V_CH8,H_CH8
		JMP TO_CH8
TO_LCH8:
		MOV V_CH8,L_CH8
TO_CH8:
		RET
		
		
		
		
MAKE:		
		MOV R0,#40H
		MOV R1,#50H
LOOP_MAKE1:
		MOV A,@R0
		CALL ADJUST
		MOV @R1,A
		INC R0
		INC R1
		CJNE R0,#48H,LOOP_MAKE1
		
		MOV R0,#50H
		MOV R1,#60H
LOOP_MAKE2:
		MOV A,@R0
		CPL A
		MOV @R1,A
		INC R0
		INC R1
		CJNE R0,#58H,LOOP_MAKE2
		RET		
		
;HIEU CHINH SO 0-1,255-254
ADJUST:
		CJNE A,#0,CON_ADJUST
		INC A
		SJMP EX_ADJUST
CON_ADJUST:
		CJNE A,#255,EX_ADJUST
		DEC A
EX_ADJUST:
		RET
; DINH THOI
TIMING:
		JNB T10MS_,C4_TIMING
		CLR T10MS_
		DJNZ C50MS,C2_TIMING
		SETB T50MS
		CPL P3.7
		MOV C50MS,#5
C2_TIMING:
		DJNZ C100MS,C3_TIMING
		SETB T100MS
		MOV C100MS,#10
C3_TIMING:
		DJNZ C500MS,C4_TIMING
		SETB T500MS
		MOV C500MS,#50
C4_TIMING:
		RET	
		END



































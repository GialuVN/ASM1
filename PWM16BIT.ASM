
;KHAI BAO
XLOW0 DATA 30H
XLOW1 DATA 31H
XHIG0 DATA 32H
XHIG1 DATA 33H
V_INC DATA 34H
V_DEC DATA 35H
TEM DATA 20H
WAR BIT TEM.0

ORG 0
JMP MAIN
ORG 000BH
JMP INT_PWM16
MAIN:
;KHOI TAO
MOV TMOD,#01H
MOV IE,#82H
SETB TR0
SETB TF0
;CT CHINH
MAINX:
	MOV XLOW1,#0
	MOV XLOW0,#1
LOOOP:
	CALL CONTRO
	MOV R0,#255
LOOP4:
	MOV V_INC,#255
	CALL TANG
	CALL DELAY
	DJNZ R0,LOOP4
	MOV R0,#255
LOOP5:
	MOV V_DEC,#255
	CALL GIAM
	CALL DELAY
	DJNZ R0,LOOP5
	JMP LOOOP
	JMP MAINX
GIAM:
	CLR C
	MOV A,XLOW0
	SUBB A,V_DEC
	MOV V_DEC,A
	MOV A,XLOW1
	SUBB A,#0
	MOV XLOW1,A
	CALL CONTRO
	RET

TANG:
	MOV A,XLOW0
	ADD A,V_INC
	MOV XLOW0,A
	MOV A,XLOW1
	ADDC A,#0
	MOV XLOW1,A
	CALL CONTRO
	RET
	
;DIEU CHINH DO RONG XUNG 1 - 65534(us)
CONTRO:
	PUSH ACC
	MOV A,XLOW0
	CPL A
	MOV XHIG0,A
	MOV A,XLOW1
	CPL A
	MOV XHIG1,A
	CLR C
	MOV A,XHIG0
	ADD A,#1
	MOV A,XHIG0
	ADDC A,#0
	POP ACC
	RET
;PHAT XUNG PWM 3.7KHZ
INT_PWM16:
	JNB WAR,SECON
	MOV P1,#00H
	MOV TH0,XLOW1
	MOV TL0,XLOW0
	CLR WAR
	RETI
SECON:
	MOV P1,#0FFH
	MOV TH0,XHIG1
	MOV TL0,XHIG0
	SETB WAR
	RETI
	
DELAY:
	PUSH 00H
	PUSH 01H
	PUSH 02H
	MOV R2,#20
LOOP2_DE:
	MOV R0,#50
LOOP_DELAY:
	MOV R1,#100
	DJNZ R1,$
	DJNZ R0,LOOP_DELAY
	DJNZ R2,LOOP2_DE
	POP 02H
	POP 01H
	POP 00H
	RET
END
	
	